---
# ansible-playbook -e '
# git_url=...
# repo_version=...
# repo_key=...
# ' deploy_app.yml
  
- name: Deploy app from git
  hosts: all
  gather_facts: false
  vars:
    - local_name: ci_cd_repo
    - git_url: false
    - repo_version: HEAD
    - repo_key: false
  
  tasks:

    - name: 'Cloning {{git_url}}'
      ansible.builtin.git:
        repo: '{{git_url}}'
        version: '{{repo_version}}'
        key_file: '{{repo_key}}'
        accept_hostkey: true
        dest: '/tmp/{{local_name}}'
        force: true
      register: clone_result
      until: clone_result is not failed
      retries: 3
      delay: 3

    - name: 'Building from docker-compose.yml'
      community.general.docker_compose:
        project_src: /tmp/{{local_name}}
        build: true

    - name: 'Deploying from docker-compose.yml'
      community.general.docker_compose:
        project_src: /tmp/{{local_name}}
        build: false
        state: present
    
    - name: 'Removing git repository'
      ansible.builtin.file:
        path: '/tmp/{{local_name}}'
        state: absent
    